generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String   @id @default(cuid())
  email      String   @unique
  password   String   @db.Text()
  create_at  DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt
  workspaces UserOnWorkspace[]
  owned_workspaces Workspace[]
  allowed_pipelines UserOnPipeline[]
  created_pipelines Pipeline[]

  @@index([email])
  @@map("users")
}

enum Permission {
  EDIT
  VIEW
}

model UserOnWorkspace {
  @@id([user_id, workspace_id])
  user_id   String
  workspace_id String
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)
  permission Permission // permission for the user added in the workspace
}

model Workspace {
  id        String   @id @default(cuid())
  public    Boolean  @default(false) // anyone can join using a link to the workspace id
  owner User @relation(fields: [owner_id], references: [id], onDelete: Cascade)
  owner_id String
  title       String
  create_at  DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt
  members UserOnWorkspace[]
  pipelines Pipeline[] // pipline list
  clients Client[] // client list
  @@map("workspaces")
}

model Pipeline {
  id        String @id @default(cuid())
  title     String
  
  // creator of the pipeline
  owner User @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  ownerId String

  workspace_id String
  workspace Workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)
  pos Int // to store the position of our pipline according to the workspace / to manage the drag and drop positions
  assignment Assignment[]
  allowed_users UserOnPipeline[] // list of users allowed to modify the pipeline
  @@map("pipelines")
}

model UserOnPipeline {
  @@id([user_id, pipeline_id])
  user_id   String
  pipeline_id String
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
  pipeline Pipeline @relation(fields: [pipeline_id], references: [id], onDelete: Cascade)
  permission Permission // permission for the user on the pipeline
  @@map("pipline_allowed_users")
}

model Assignment {
  id String @id @default(cuid())
  pipeline_id String
  pipline Pipeline @relation(fields: [pipeline_id], references: [id], onDelete: Cascade)
  client_id String
  client Client @relation(fields: [client_id], references: [id], onDelete: Cascade)
  @@map("assignments")
}

model Client {
  id        String @id @default(cuid())
  @@unique([email, workspaceId]) // unique email for the workspace

  name      String
  email     String  // the email should be unique to the user that created it
  phone     String 
  
  workspaceId String
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  assignment Assignment[]

  create_at  DateTime @default(now()) // for the created at display in the client list
  updated_at DateTime @default(now()) @updatedAt // for the edition date display in the client list

  @@map("clients")
}



